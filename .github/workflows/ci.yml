name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  # Detect changed paths
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      dbt: ${{ steps.filter.outputs.dbt }}
      cli: ${{ steps.filter.outputs.cli }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            dbt:
              - 'code/dbt/**'
            cli:
              - 'code/cli/**'

  # Run pre-commit hooks
  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.dbt == 'true' || needs.changes.outputs.cli == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin latest

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks on changed files only
        # Skip sqlfluff in CI (requires dbt profile) - keep for local pre-commit only
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs: check files changed between base and head
            SKIP=sqlfluff-lint,sqlfluff-fix pre-commit run --from-ref origin/${{ github.base_ref }} --to-ref HEAD
          else
            # For pushes: check files changed in the last commit
            SKIP=sqlfluff-lint,sqlfluff-fix pre-commit run --from-ref HEAD~1 --to-ref HEAD
          fi

  # cli tests
  cli-test:
    name: CLI Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.cli == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Run tests
        working-directory: code/cli
        run: go test -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: code/cli/coverage.out
          flags: go
          name: go-coverage
          fail_ci_if_error: false

  # dbt tests (placeholder - to be implemented)
  dbt-test:
    name: DBT Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.dbt == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: DBT tests (placeholder)
        working-directory: code/dbt
        run: |
          echo "DBT tests will be implemented here"
          echo "TODO: Add dbt test execution and coverage reporting"
          # Future: dbt test
          # Future: Upload coverage
