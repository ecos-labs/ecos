version: 2

models:
  # Account Metadata
  - name: serve_meta__account_metadata
    description: |
      Consolidated metadata for all AWS accounts in the organization, including both linked accounts (where usage occurs) and payer accounts (responsible for billing).
      This model provides a master list of all accounts with their names and types, useful for account management, cost allocation, and organizational reporting.

      Key features:
      - Sources data from the complete CUR history for comprehensive account information
      - Groups and deduplicates account information from CUR data
      - Distinguishes between linked and payer accounts
      - Provides last updated timestamp for data freshness tracking
    data_tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - account_id
            - account_type
          config:
            severity: error
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1
          config:
            severity: error
    columns:
      - name: account_id
        description: AWS account identifier (12-digit number).
        data_type: varchar
        tests:
          - not_null
          - unique:
              config:
                where: account_type = 'linked'
          - dbt_expectations.expect_column_value_lengths_to_equal:
              value: 12
              config:
                severity: error
      - name: account_name
        description: Human-readable AWS account name (may be NULL if not available in CUR data).
        data_type: varchar
        tests:
          - dbt_expectations.expect_column_value_lengths_to_be_between:
              min_value: 1
              max_value: 500
              config:
                severity: warn
                where: "account_name is not null"
      - name: account_type
        description: Type of account (e.g., linked or payer).
        data_type: varchar
        tests:
          - not_null
          - accepted_values:
              values:
                - linked
                - payer
      - name: last_updated
        description: Timestamp when the record was last updated.
        data_type: string
        tests:
          - not_null

  # AWS Cost Services Daily with Account Names
  - name: serve_core__cost_service_account_daily
    description: |
      Ready-to-consume daily cost data by AWS service with enriched account information. This model joins cost services data with account metadata to provide human-readable linked account names alongside cost metrics, making it ideal for reporting and analytics.

      Key features:
      - Daily cost aggregation by AWS service
      - Enriched with linked account names for usage context
      - Includes all cost types (effective, billed, list)
      - Optimized for business reporting and dashboards, ordered by date and cost for easy analysis
    data_tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - usage_date
            - account_id
            - service_code
          config:
            severity: error
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1
          config:
            severity: warn
    columns:
      - name: usage_date
        description: Date when the AWS service was used.
        data_type: timestamp
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: timestamp
      - name: billing_period
        description: Billing period in YYYY-MM format.
        data_type: varchar
        tests:
          - not_null
      - name: account_id
        description: AWS linked account identifier where usage occurred.
        data_type: varchar
        tests:
          - not_null
          - relationships:
              to: ref('serve_meta__account_metadata')
              field: account_id
              config:
                severity: warn
      - name: account_name
        description: Human-readable name of the linked account.
        data_type: varchar
      - name: payer_account_id
        description: AWS payer account identifier responsible for billing.
        data_type: varchar
        tests:
          - not_null
          - relationships:
              to: ref('serve_meta__account_metadata')
              field: account_id
              config:
                severity: warn
      - name: billing_entity
        description: AWS billing entity (e.g., AWS or AWS Marketplace).
        data_type: varchar
      - name: service_code
        description: AWS service code (e.g., AmazonEC2, AmazonS3).
        data_type: varchar
        tests:
          - not_null
      - name: service_name
        description: Cleaned and standardized AWS service name.
        data_type: varchar
        tests:
          - not_null
      - name: service_category
        description: Standardized service category (e.g., Compute, Storage, Network).
        data_type: varchar
        tests:
          - not_null
      - name: total_effective_cost
        description: >
          Total effective cost after applying all discounts, credits, and RI/SP benefits.
          This represents the actual cost to the organization.
        data_type: decimal
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1000000000  # 1 billion - investigate if exceeded (may be legitimate for large deployments)
              config:
                severity: warn
      - name: total_billed_cost
        description: >
          Total unblended cost that appears on the bill.
          This is the cost before any volume discounts or credits.
        data_type: decimal
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1000000000  # 1 billion - investigate if exceeded (may be legitimate for large deployments)
              config:
                severity: warn
      - name: total_list_cost
        description: >
          Total public on-demand list price cost.
          This is the standard catalog price before any discounts.
        data_type: decimal
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1000000000  # 1 billion - investigate if exceeded (may be legitimate for large deployments)
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              expression: '>= total_effective_cost'
              config:
                severity: error
